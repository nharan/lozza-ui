<!DOCTYPE html>
<html>
<head>
    <title>UI Integration Tests - Self-Capture Chess</title>
    <link rel="stylesheet" href="css/chessboard-0.3.0.min.css">
    <script src="jquery-ui-1.8.24/js/jquery-1.8.2.min.js"></script>
    <script src="js/chessboard-0.3.0.min.js"></script>
    <script src="js/chess.js"></script>
    <script src="lozza.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #2b2b2b;
            color: #e0e0e0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4CAF50;
            text-align: center;
        }
        .test-panel {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .board-container {
            flex: 1;
        }
        #board {
            width: 400px;
        }
        .controls {
            flex: 1;
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 14px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .test-output {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .test-pass {
            color: #4CAF50;
        }
        .test-fail {
            color: #f44336;
        }
        .test-info {
            color: #2196F3;
        }
        .stats {
            background: #2d2d30;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        .stats-label {
            font-weight: bold;
        }
        .move-history {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        .self-capture {
            color: #ff9800;
            font-weight: bold;
        }
        .section-title {
            color: #2196F3;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¯ UI Integration Tests - Self-Capture Chess</h1>
        
        <div class="stats">
            <div class="stats-row">
                <span class="stats-label">Tests Passed:</span>
                <span id="testsPassed">0</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Tests Failed:</span>
                <span id="testsFailed">0</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Game Moves:</span>
                <span id="moveCount">0</span>
            </div>
            <div class="stats-row">
                <span class="stats-label">Self-Captures:</span>
                <span id="selfCaptureCount">0</span>
            </div>
        </div>

        <div class="test-panel">
            <div class="board-container">
                <div id="board"></div>
                <div class="move-history" id="moveHistory"></div>
            </div>

            <div class="controls">
                <div class="section-title">Automated Tests</div>
                <button onclick="runAllTests()">Run All Tests</button>
                <button onclick="clearOutput()">Clear Output</button>
                
                <div class="section-title">Manual Tests</div>
                <button onclick="testDragDropSelfCapture()">Test Drag & Drop Self-Capture</button>
                <button onclick="testAIGame()">Test AI vs AI Game</button>
                <button onclick="testSpecialMoves()">Test Special Moves</button>
                <button onclick="resetBoard()">Reset Board</button>
                
                <div class="test-output" id="output"></div>
            </div>
        </div>
    </div>

    <script>
        let chess = new Chess();
        let board = null;
        let testsPassed = 0;
        let testsFailed = 0;
        let moveCount = 0;
        let selfCaptureCount = 0;
        let gameRunning = false;

        // Initialize board
        function initBoard() {
            board = ChessBoard('board', {
                draggable: true,
                position: 'start',
                pieceTheme: 'img/chesspieces/wikipedia/{piece}.png',
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd
            });
        }

        function onDragStart(source, piece, position, orientation) {
            if (chess.game_over()) return false;
            if ((chess.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (chess.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }

        function onDrop(source, target) {
            // Check if this is a self-capture
            const sourcePiece = chess.get(source);
            const targetPiece = chess.get(target);
            const isSelfCapture = targetPiece && sourcePiece && 
                                  targetPiece.color === sourcePiece.color;

            const move = chess.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            moveCount++;
            if (isSelfCapture) {
                selfCaptureCount++;
                addMoveToHistory(move, true);
            } else {
                addMoveToHistory(move, false);
            }
            updateStats();
        }

        function onSnapEnd() {
            board.position(chess.fen());
        }

        function addMoveToHistory(move, isSelfCapture) {
            const history = document.getElementById('moveHistory');
            const moveText = `${moveCount}. ${move.color === 'w' ? 'White' : 'Black'}: ${move.san}`;
            const moveElement = document.createElement('div');
            moveElement.textContent = moveText;
            if (isSelfCapture) {
                moveElement.className = 'self-capture';
                moveElement.textContent += ' [SELF-CAPTURE]';
            }
            history.appendChild(moveElement);
            history.scrollTop = history.scrollHeight;
        }

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const line = document.createElement('div');
            line.textContent = message;
            line.className = `test-${type}`;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function assert(condition, testName) {
            if (condition) {
                log(`âœ“ ${testName}`, 'pass');
                testsPassed++;
            } else {
                log(`âœ— ${testName}`, 'fail');
                testsFailed++;
            }
            updateStats();
        }

        function updateStats() {
            document.getElementById('testsPassed').textContent = testsPassed;
            document.getElementById('testsFailed').textContent = testsFailed;
            document.getElementById('moveCount').textContent = moveCount;
            document.getElementById('selfCaptureCount').textContent = selfCaptureCount;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
            document.getElementById('moveHistory').innerHTML = '';
        }

        function resetBoard() {
            chess.reset();
            board.position('start');
            moveCount = 0;
            selfCaptureCount = 0;
            gameRunning = false;
            updateStats();
            log('Board reset', 'info');
        }

        // ============================================================================
        // AUTOMATED TESTS
        // ============================================================================

        function runAllTests() {
            clearOutput();
            testsPassed = 0;
            testsFailed = 0;
            
            log('='.repeat(60), 'info');
            log('RUNNING UI INTEGRATION TESTS', 'info');
            log('='.repeat(60), 'info');

            testBoardInitialization();
            testMoveDisplay();
            testSelfCaptureDisplay();
            testGameStateDisplay();
            testPositionUpdate();
            testMoveValidation();
            
            log('', 'info');
            log('='.repeat(60), 'info');
            log(`TESTS COMPLETE: ${testsPassed} passed, ${testsFailed} failed`, 'info');
            log('='.repeat(60), 'info');
        }

        function testBoardInitialization() {
            log('', 'info');
            log('--- Test: Board Initialization ---', 'info');
            
            assert(board !== null, 'Board object created');
            assert(chess !== null, 'Chess engine created');
            
            const position = board.position();
            assert(Object.keys(position).length === 32, 'Board has 32 pieces initially');
        }

        function testMoveDisplay() {
            log('', 'info');
            log('--- Test: Move Display ---', 'info');
            
            chess.reset();
            board.position('start');
            
            // Make a normal move
            const move = chess.move('e4');
            board.position(chess.fen());
            
            assert(move !== null, 'Normal move executes');
            
            const position = board.position();
            assert(position.e4 === 'wP', 'Board displays move correctly');
            
            chess.undo();
            board.position(chess.fen());
        }

        function testSelfCaptureDisplay() {
            log('', 'info');
            log('--- Test: Self-Capture Display ---', 'info');
            
            // Set up position with self-capture opportunity
            chess.load('8/8/8/8/8/2P5/1P6/B7 w - - 0 1');
            board.position(chess.fen());
            
            assert(chess.get('a1').type === 'b', 'Position loaded correctly');
            
            // Execute self-capture
            const move = chess.move({ from: 'a1', to: 'b2' });
            board.position(chess.fen());
            
            assert(move !== null, 'Self-capture move executes');
            assert(move.captured === 'p', 'Self-capture detected');
            
            const position = board.position();
            assert(position.b2 === 'wB', 'Board displays self-capture correctly');
            assert(position.a1 === undefined, 'Source square cleared');
        }

        function testGameStateDisplay() {
            log('', 'info');
            log('--- Test: Game State Display ---', 'info');
            
            chess.reset();
            board.position('start');
            
            assert(!chess.game_over(), 'Game not over at start');
            assert(!chess.in_check(), 'Not in check at start');
            assert(!chess.in_checkmate(), 'Not in checkmate at start');
            
            // Set up checkmate position
            chess.load('4k3/8/4K3/8/8/8/8/4R3 w - - 0 1');
            board.position(chess.fen());
            chess.move({ from: 'e1', to: 'e8' });
            board.position(chess.fen());
            
            assert(chess.in_checkmate(), 'Checkmate detected');
            assert(chess.game_over(), 'Game over detected');
        }

        function testPositionUpdate() {
            log('', 'info');
            log('--- Test: Position Update ---', 'info');
            
            chess.reset();
            board.position('start');
            
            // Make several moves
            const moves = ['e4', 'e5', 'Nf3', 'Nc6'];
            for (const moveStr of moves) {
                chess.move(moveStr);
            }
            
            board.position(chess.fen());
            const position = board.position();
            
            assert(position.e4 === 'wP', 'Position updates correctly (e4)');
            assert(position.e5 === 'bP', 'Position updates correctly (e5)');
            assert(position.f3 === 'wN', 'Position updates correctly (Nf3)');
            assert(position.c6 === 'bN', 'Position updates correctly (Nc6)');
        }

        function testMoveValidation() {
            log('', 'info');
            log('--- Test: Move Validation ---', 'info');
            
            chess.reset();
            board.position('start');
            
            // Try invalid move
            const invalidMove = chess.move({ from: 'e2', to: 'e5' });
            assert(invalidMove === null, 'Invalid move rejected');
            
            // Try valid move
            const validMove = chess.move({ from: 'e2', to: 'e4' });
            assert(validMove !== null, 'Valid move accepted');
            
            // Try move into check
            chess.load('4k3/8/8/8/8/8/4r3/4K3 w - - 0 1');
            const checkMove = chess.move({ from: 'e1', to: 'e2' });
            assert(checkMove === null, 'Move into check rejected');
        }

        // ============================================================================
        // MANUAL TESTS
        // ============================================================================

        function testDragDropSelfCapture() {
            log('', 'info');
            log('=== Manual Test: Drag & Drop Self-Capture ===', 'info');
            log('Position set up with self-capture opportunity', 'info');
            log('Try dragging the bishop from a1 to b2 or c3', 'info');
            
            chess.load('8/8/8/8/8/2P5/1P6/B7 w - - 0 1');
            board.position(chess.fen());
            moveCount = 0;
            selfCaptureCount = 0;
            updateStats();
        }

        async function testAIGame() {
            if (gameRunning) {
                log('Game already running', 'info');
                return;
            }
            
            log('', 'info');
            log('=== Manual Test: AI vs AI Game ===', 'info');
            log('Starting AI vs AI game...', 'info');
            
            chess.reset();
            board.position('start');
            moveCount = 0;
            selfCaptureCount = 0;
            gameRunning = true;
            updateStats();
            
            // Initialize Lozza
            uciExec('uci');
            uciExec('ucinewgame');
            
            playAIMove();
        }

        function playAIMove() {
            if (!gameRunning || chess.game_over()) {
                gameRunning = false;
                if (chess.in_checkmate()) {
                    log(`Game Over: Checkmate! ${chess.turn() === 'w' ? 'Black' : 'White'} wins!`, 'info');
                } else if (chess.in_stalemate()) {
                    log('Game Over: Stalemate!', 'info');
                }
                return;
            }

            // Get AI move
            uciExec(`position fen ${chess.fen()}`);
            uciExec('go depth 3');
            
            const bestmove = lastBestMove;
            if (bestmove && bestmove.length >= 4) {
                const from = bestmove.substring(0, 2);
                const to = bestmove.substring(2, 4);
                
                // Check if self-capture
                const sourcePiece = chess.get(from);
                const targetPiece = chess.get(to);
                const isSelfCapture = targetPiece && sourcePiece && 
                                      targetPiece.color === sourcePiece.color;
                
                const move = chess.move({ from, to });
                if (move) {
                    board.position(chess.fen());
                    moveCount++;
                    if (isSelfCapture) {
                        selfCaptureCount++;
                        addMoveToHistory(move, true);
                    } else {
                        addMoveToHistory(move, false);
                    }
                    updateStats();
                    
                    // Continue game
                    setTimeout(playAIMove, 500);
                } else {
                    log('AI suggested invalid move', 'fail');
                    gameRunning = false;
                }
            } else {
                log('AI did not return a move', 'fail');
                gameRunning = false;
            }
        }

        function testSpecialMoves() {
            log('', 'info');
            log('=== Manual Test: Special Moves ===', 'info');
            
            // Test castling
            log('Testing castling...', 'info');
            chess.load('r3k2r/8/8/8/8/8/8/R3K2R w KQkq - 0 1');
            board.position(chess.fen());
            
            const moves = chess.moves({ verbose: true });
            const castling = moves.filter(m => m.flags.includes('k') || m.flags.includes('q'));
            
            assert(castling.length > 0, 'Castling moves available');
            log(`Found ${castling.length} castling moves`, 'info');
            log('Try castling by dragging the king', 'info');
        }

        // Initialize on load
        window.onload = function() {
            initBoard();
            log('UI Integration Tests Ready', 'info');
            log('Click "Run All Tests" to start automated tests', 'info');
            log('Or use manual test buttons to test interactively', 'info');
        };
    </script>
</body>
</html>
